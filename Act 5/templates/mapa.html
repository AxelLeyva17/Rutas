<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa | RutasTj</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { overflow: hidden; font-family: 'Inter', sans-serif; }
        
        /* TRANSICIONES */
        #sidebar { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-hidden { width: 0 !important; padding: 0 !important; overflow: hidden; opacity: 0; }

        /* ESTILOS DEL POPUP */
        .leaflet-popup-content-wrapper { 
            padding: 0 !important; 
            border-radius: 1rem !important; 
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        }
        .leaflet-popup-content { margin: 0 !important; width: auto !important; }
        .leaflet-popup-tip { background: #0f172a; } 
        .leaflet-container a.leaflet-popup-close-button { display: none; } 

        /* CONTENEDOR DEL ICONO PERSONALIZADO */
        .custom-div-icon {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body class="bg-slate-50 h-screen relative w-full overflow-hidden">

    <header class="absolute top-0 left-0 w-full h-[70px] bg-slate-900/90 backdrop-blur-md border-b border-slate-800/50 flex items-center justify-between px-6 z-[1000] shadow-2xl">
        <div class="flex items-center space-x-4">
            <a href="/" class="text-slate-400 hover:text-amber-500 transition transform hover:scale-110">
                <i class="fas fa-home text-xl"></i>
            </a>
            <span class="font-bold italic text-white text-xl tracking-tight">RUTAS<span class="text-amber-500">TJ</span></span>
        </div>
        <div id="indicador-contador" class="bg-slate-800 text-amber-500 px-4 py-1.5 rounded-full text-xs font-bold border border-slate-700 tracking-wider shadow-inner">
            0 PUNTOS
        </div>
    </header>

    <div class="flex h-full w-full relative">

        <main class="flex-grow relative h-full">
            <div id="map" class="h-full w-full z-0 outline-none"></div>
            
            <button id="btn-mostrar-panel" class="absolute top-24 right-6 z-[900] bg-slate-900 text-amber-500 w-12 h-12 rounded-xl shadow-2xl border border-slate-700 hover:bg-slate-800 transition transform hover:scale-110 flex items-center justify-center group" title="Mostrar Lista">
                <i class="fas fa-list-ul text-lg group-hover:animate-pulse"></i>
            </button>
        </main>

        <aside id="sidebar" class="w-[340px] bg-white border-l border-slate-200 flex flex-col h-full shadow-2xl z-[900] pt-[70px] relative sidebar-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white">
                <div>
                    <h2 class="font-black text-slate-800 text-lg uppercase tracking-tight">Mis Lugares</h2>
                    <p class="text-xs text-slate-400">Puntos registrados</p>
                </div>
                <button id="btn-ocultar-panel" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-amber-100 hover:text-amber-600 transition flex items-center justify-center" title="Expandir Mapa">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div id="lista-puntos" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                <div id="empty-state" class="flex flex-col items-center justify-center h-[300px] text-center opacity-60">
                    <div class="bg-slate-100 p-4 rounded-full mb-4"><i class="fas fa-map-marker-alt text-4xl text-slate-300"></i></div>
                    <h3 class="text-slate-600 font-bold text-sm">Sin ubicaciones</h3>
                    <p class="text-xs text-slate-400 mt-1 max-w-[180px]">Haz clic en el mapa para agregar un punto.</p>
                </div>
            </div>
        </aside>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const uttCoords = [32.4575, -116.8256];
        const map = L.map('map', { zoomControl: false }).setView(uttCoords, 14);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // --- LÓGICA SIDEBAR ---
        const sidebar = document.getElementById('sidebar');
        const btnOcultar = document.getElementById('btn-ocultar-panel');
        const btnMostrar = document.getElementById('btn-mostrar-panel');
        
        btnOcultar.addEventListener('click', () => {
            sidebar.classList.add('sidebar-hidden'); 
            btnMostrar.classList.remove('hidden');   
            setTimeout(() => { map.invalidateSize(); }, 400);
        });

        btnMostrar.addEventListener('click', () => {
            sidebar.classList.remove('sidebar-hidden');
            btnMostrar.classList.add('hidden');
            setTimeout(() => { map.invalidateSize(); }, 400);
        });

        const customIcon = L.divIcon({
            html: `<div class="relative flex items-center justify-center transform hover:scale-125 transition-transform duration-200">
                    <i class="fas fa-location-pin text-amber-500 text-5xl drop-shadow-lg filter drop-shadow-[0_4px_3px_rgba(0,0,0,0.5)]"></i>
                   </div>`,
            className: 'custom-div-icon',
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -45]
        });

        let marcadorTemp = null;
        let contador = 0;

        map.on('click', (e) => {
            const { lat, lng } = e.latlng;
            if(marcadorTemp) marcadorTemp.remove();
            
            marcadorTemp = L.marker([lat, lng], {icon: customIcon}).addTo(map);

            const popupHtml = `
                <div class="w-[280px] bg-white font-sans">
                    <div class="bg-slate-900 p-4 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-amber-500 flex items-center justify-center text-slate-900 shadow-lg animate-pulse">
                            <i class="fas fa-map-pin text-sm"></i>
                        </div>
                        <div>
                            <h3 class="text-white font-bold text-sm tracking-wide uppercase leading-tight">Nueva Ubicación</h3>
                            <p class="text-slate-400 text-[10px]">¿Guardar este punto?</p>
                        </div>
                    </div>
                    
                    <div class="p-5">
                        <div class="bg-slate-50 border border-slate-100 rounded-lg p-3 mb-4 text-center">
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Coordenadas</p>
                            <p class="text-slate-700 font-mono text-xs font-semibold">${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button id="btn-cancel" class="py-2.5 rounded-lg border border-slate-200 text-slate-500 text-xs font-bold hover:bg-slate-50 hover:text-red-500 transition-colors">
                                CANCELAR
                            </button>
                            <button id="btn-save" class="py-2.5 rounded-lg bg-amber-500 text-slate-900 text-xs font-bold shadow-lg shadow-amber-500/30 hover:bg-amber-400 hover:scale-[1.02] transition-all">
                                GUARDAR
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            marcadorTemp.bindPopup(popupHtml, { closeButton: false }).openPopup();

            setTimeout(() => {
                const btnCancel = document.getElementById('btn-cancel');
                const btnSave = document.getElementById('btn-save');

                if (btnCancel) btnCancel.onclick = () => { map.removeLayer(marcadorTemp); marcadorTemp = null; };
                if (btnSave) btnSave.onclick = () => {
                    btnSave.innerHTML = '<i class="fas fa-circle-notch animate-spin"></i>'; 
                    guardarPunto(lat, lng);
                };
            }, 50);
        });

        function guardarPunto(lat, lng) {
            fetch('/guardar_punto', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lat, lng})
            }).catch(e => console.log("Simulado"));

            setTimeout(() => {
                // 1. Mostrar mensaje de éxito
                if (marcadorTemp) {
                    marcadorTemp.getPopup().setContent(`
                        <div class="p-6 text-center w-[200px]">
                            <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-2 shadow-sm">
                                <i class="fas fa-check text-xl"></i>
                            </div>
                            <p class="text-slate-800 font-bold text-sm">¡Guardado con éxito!</p>
                        </div>
                    `);
                    
                    // CAMBIO 3: Desaparecer el popup después de 1 segundo
                    setTimeout(() => {
                        map.closePopup(); // Cierra el popup automáticamente
                        marcadorTemp = null; // Limpiamos la referencia
                    }, 1000);
                }
                
                // 2. Agregar a la lista
                contador++;
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('indicador-contador').innerText = `${contador} PUNTOS`;
                
                const item = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:border-amber-400 group transition-all animate-[fadeIn_0.5s_ease-out] relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-amber-500"></div>
                        <div class="flex justify-between items-start pl-2">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-0.5 rounded uppercase">Punto #${contador}</span>
                                    <span class="text-[10px] text-slate-400">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                </div>
                                <p class="text-xs text-slate-500 font-mono mt-1 bg-slate-50 inline-block px-1 rounded">
                                    ${lat.toFixed(4)}, ${lng.toFixed(4)}
                                </p>
                            </div>
                            <button class="w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:bg-red-50 hover:text-red-500 transition" onclick="this.parentElement.parentElement.parentElement.remove()">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('lista-puntos').insertAdjacentHTML('afterbegin', item);
                // marcadorTemp se limpia en el timeout de arriba
            }, 600);
        }
    </script>
</body>
</html>